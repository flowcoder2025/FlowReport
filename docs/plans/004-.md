# FlowReport 남은 작업 구현 계획

## 개요

남은 작업과 선택 작업을 모두 구현합니다.

| 우선순위 | 작업 | 난이도 | 상태 |
|---------|------|--------|------|
| 1 | PNG 내보내기 | 낮음 | 코드 있음, UI 연결만 |
| 2 | 워크스페이스 생성 페이지 | 낮음 | API 있음, UI만 |
| 3 | CSV 업로드 UI | 중간 | API 있음, UI만 |
| 4 | 채널 연결 관리 UI | 높음 | API + UI 모두 필요 |

---

## Phase 1: PNG 내보내기 (간단)

### 현재 상태
- ✅ `html-to-image` 설치됨
- ✅ `src/lib/export/png-generator.ts` 클라이언트 함수 있음
- ✅ `id="monthly-summary"` 타겟 있음
- ❌ UI 버튼 연결 안됨

### 구현

**파일**: `src/components/dashboard/monthly/index.tsx`

```typescript
// 기존 handleExportPNG 수정
import { generateAndDownloadPNG } from '@/lib/export/png-generator'

const handleExportPNG = async () => {
  const filename = `monthly-report-${format(periodStart, 'yyyy-MM')}.png`
  await generateAndDownloadPNG('monthly-summary', filename)
}
```

---

## Phase 2: 워크스페이스 생성 페이지

### 현재 상태
- ✅ POST `/api/workspaces` API 있음
- ❌ `/workspaces/new` 페이지 없음

### 구현

**신규 파일**: `src/app/(dashboard)/workspaces/new/page.tsx`

```typescript
// 폼 필드
- name: string (필수)
- slug: string (필수, 자동 생성 옵션)
- description: string (선택)
- timezone: select (기본: Asia/Seoul)
- weekStart: select (기본: 월요일)

// 제출 시 POST /api/workspaces 호출
// 성공 시 /workspaces/[id]로 리다이렉트
```

**재사용 컴포넌트**:
- `Card`, `Button` from `@/components/ui`
- `Input`, `Select` 컴포넌트 필요 (shadcn/ui 추가)

---

## Phase 3: CSV 업로드 UI

### 현재 상태
- ✅ POST `/api/csv/upload` API 완전 구현됨
- ✅ GET `/api/csv/upload?channel=X` 템플릿 다운로드
- ✅ CSV 파싱, 검증, 저장 로직 있음
- ❌ UI 컴포넌트 없음

### 구현

**신규 파일**: `src/components/dashboard/csv-upload.tsx`

```typescript
interface CsvUploadProps {
  workspaceId: string
  onSuccess?: () => void
}

// 기능
- 채널 선택 드롭다운
- 파일 드래그 앤 드롭 또는 클릭 업로드
- 템플릿 다운로드 버튼
- 업로드 진행 상태
- 검증 오류 표시
- 성공/실패 토스트
```

**위치**: 대시보드 내 탭 또는 설정 페이지

---

## Phase 4: 채널 연결 관리 UI

### 현재 상태
- ✅ `ChannelConnection` 모델 있음
- ✅ 커넥터 구현 있음 (GA4, Meta, YouTube, SmartStore, Coupang)
- ✅ 암호화 유틸리티 있음
- ❌ API 엔드포인트 없음
- ❌ UI 없음

### 4.1 API 엔드포인트

**신규 파일**: `src/app/api/workspaces/[workspaceId]/connections/route.ts`

```typescript
// GET - 연결 목록
// POST - 새 연결 생성

// 응답
{
  connections: [{
    id, provider, accountName, status, lastSyncAt, syncEnabled
  }]
}
```

**신규 파일**: `src/app/api/workspaces/[workspaceId]/connections/[connectionId]/route.ts`

```typescript
// GET - 상세 조회
// PUT - 수정 (syncEnabled 토글 등)
// DELETE - 삭제
// POST /test - 연결 테스트
```

### 4.2 UI 컴포넌트

**신규 파일**: `src/app/(dashboard)/workspaces/[workspaceId]/settings/page.tsx`

```
설정 페이지 구조:
├── 워크스페이스 정보 (이름, 설명 수정)
├── 채널 연결 관리
│   ├── 연결된 채널 목록
│   ├── 채널 추가 버튼
│   └── 각 채널별 상태/동기화/삭제
├── 멤버 관리 (선택)
└── CSV 업로드 (Phase 3 컴포넌트 재사용)
```

**신규 파일**: `src/components/dashboard/channel-connection-card.tsx`

```typescript
// 각 채널 연결 카드
- 채널 아이콘 + 이름
- 연결 상태 (Active/Error/Pending)
- 마지막 동기화 시간
- 동기화 활성화 토글
- 테스트/삭제 버튼
```

**신규 파일**: `src/components/dashboard/add-channel-modal.tsx`

```typescript
// 새 채널 추가 모달
- 채널 선택 (GA4, Meta, YouTube, SmartStore, Coupang)
- 채널별 인증 방식:
  - GA4: 서비스 계정 JSON 업로드
  - Meta/YouTube: OAuth 리다이렉트
  - SmartStore/Coupang: CSV_ONLY (연결만 생성)
```

---

## 파일 목록

### 신규 파일
| 파일 | 설명 |
|------|------|
| `src/app/(dashboard)/workspaces/new/page.tsx` | 워크스페이스 생성 |
| `src/app/(dashboard)/workspaces/[workspaceId]/settings/page.tsx` | 설정 페이지 |
| `src/app/api/workspaces/[workspaceId]/connections/route.ts` | 연결 목록/생성 API |
| `src/app/api/workspaces/[workspaceId]/connections/[connectionId]/route.ts` | 연결 상세 API |
| `src/components/dashboard/csv-upload.tsx` | CSV 업로드 컴포넌트 |
| `src/components/dashboard/channel-connection-card.tsx` | 채널 연결 카드 |
| `src/components/dashboard/add-channel-modal.tsx` | 채널 추가 모달 |
| `src/components/ui/input.tsx` | Input 컴포넌트 (shadcn) |
| `src/components/ui/select.tsx` | Select 컴포넌트 (shadcn) |

### 수정 파일
| 파일 | 변경 내용 |
|------|----------|
| `src/components/dashboard/monthly/index.tsx` | PNG 내보내기 연결 |
| `src/components/dashboard/nav.tsx` | 설정 페이지 링크 추가 |

---

## 재사용할 기존 코드

| 파일 | 함수/컴포넌트 | 용도 |
|------|-------------|------|
| `src/lib/export/png-generator.ts` | `generateAndDownloadPNG` | PNG 내보내기 |
| `src/lib/crypto/credentials.ts` | `encryptCredentials` | 자격증명 암호화 |
| `src/lib/permissions/workspace-middleware.ts` | `requireWorkspaceEditor` | 권한 검증 |
| `src/lib/connectors/*.ts` | `testConnection` | 연결 테스트 |
| `src/app/api/csv/upload/route.ts` | 템플릿 로직 | CSV 템플릿 |

---

## 의존성 순서

```
Phase 1 (PNG) ──────────────────────────────────┐
                                                │
Phase 2 (워크스페이스 생성) ────────────────────┤ 병렬 가능
                                                │
Phase 3 (CSV 업로드 UI) ────────────────────────┤
                                                │
Phase 4 (채널 연결) ◄───────────────────────────┘ Phase 3 완료 후
   │
   ├── 4.1: API 엔드포인트
   └── 4.2: UI 컴포넌트 (API 완료 후)
```

---

## 검증 방법

### Phase 1: PNG
1. 월간 대시보드 접속
2. PNG 버튼 클릭
3. 파일 다운로드 확인

### Phase 2: 워크스페이스 생성
1. `/workspaces` 페이지에서 "새 워크스페이스" 클릭
2. 폼 입력 후 제출
3. 새 워크스페이스 대시보드로 이동 확인

### Phase 3: CSV 업로드
1. 설정 페이지에서 CSV 업로드 섹션
2. 템플릿 다운로드 → 데이터 입력 → 업로드
3. 대시보드에서 데이터 반영 확인

### Phase 4: 채널 연결
1. 설정 페이지에서 "채널 추가"
2. 채널 선택 → 인증 정보 입력
3. 연결 테스트 → 저장
4. 연결 목록에서 상태 확인
